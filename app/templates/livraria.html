<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skoob â€¢ Estante de Livros</title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<link rel="preconnect" href="https://fonts.googleapis.com">

<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Suas fontes -->
<link href="https://fonts.googleapis.com/css2?family=Momo+Signature&family=Playwrite+HU:wght@100..400&display=swap" rel="stylesheet">

<link rel="stylesheet" href="{{ url_for('static', filename='css/style-livraria.css') }}">

</head>

<body>

<header class="sk-header">
  <div class="container-fluid d-flex align-items-center position-relative">
    
    <div class="nav-left">
      <button class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#skOffcanvas">
        <i class="fas fa-bars"></i>
      </button>
    </div>

    <div class="center-logo" aria-hidden="true">
      <a href="{{ url_for('main.home') }}"> 
        <img src="{{ url_for('static', filename='images/skoob-amor-verao.png') }}" width="200" alt="Skoob Logo">
      </a>
    </div>

    <div class="ms-auto">
      {% if usuario %}
        <span id="nomeuser" class="mb-0 fw-bold" id="nomeuser">OlÃ¡, {{ usuario.apelido }}!</span>
      {% endif %}
    </div>
  </div>
</header>

<div class="offcanvas offcanvas-start sk-offcanvas" tabindex="-1" id="skOffcanvas">
  <div class="offcanvas-header">
    
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  
  <div class="offcanvas-body">
    <nav class="nav flex-column">
      <a class="nav-link" href="{{ url_for('main.home') }}"><i class="fas fa-home"></i>Inicio</a>
      <a class="nav-link"><i class="fas fa-user"></i>Perfil</a>
      <a class="nav-link" href="{{ url_for('livro.minhaestante') }}"><i class="fas fa-book"></i>Minha Estante</a>
      <a class="nav-link" href="{{ url_for('livro.logout') }}"><i class="fas fa-door-open"></i>Sair</a>
      <hr>

      <div class="category-header">Categorias</div>
      <a class="nav-link" href="{{ url_for('livro.livraria', _anchor='carouselSuspense') }}"><i class="fas fa-mask"></i>Suspense</a>
      <a class="nav-link" href="{{ url_for('livro.livraria', _anchor='carouselRomance') }}"><i class="fas fa-heart"></i>Romance</a>
      <a class="nav-link" href="{{ url_for('livro.livraria', _anchor='carouselFantasia') }}"><i class="fas fa-dragon"></i>Fantasia</a>
    </nav>
  </div>
</div>

<main class="hero-band">
  <div class="container page-container">

    <div class="row align-items-center mb-3">
      <div class="col-md-12 text-center">
        <h1>Estante de Livros</h1>
        <p class="text-muted">Confira os livros mais bem avaliados pelos leitores.</p>
      </div>
    </div>

    <section class="mb-5">
      <div class="category-banner">Suspense</div>

      <div id="carouselSuspense" class="carousel slide" data-bs-ride="false">
        <div class="carousel-inner"></div>

        <button class="carousel-control-prev" type="button" data-bs-target="#carouselSuspense" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Anterior</span>
        </button>

        <button class="carousel-control-next" type="button" data-bs-target="#carouselSuspense" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">PrÃ³ximo</span>
        </button>
      </div>
    </section>

    <section class="mb-5">
      <div class="category-banner">Romance</div>

      <div id="carouselRomance" class="carousel slide" data-bs-ride="false">
        <div class="carousel-inner"></div>

        <button class="carousel-control-prev" type="button" data-bs-target="#carouselRomance" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Anterior</span>
        </button>

        <button class="carousel-control-next" type="button" data-bs-target="#carouselRomance" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">PrÃ³ximo</span>
        </button>
      </div>
    </section>

    <section class="mb-5">
      <div class="category-banner">Fantasia</div>

      <div id="carouselFantasia" class="carousel slide" data-bs-ride="false">
        <div class="carousel-inner"></div>

        <button class="carousel-control-prev" type="button" data-bs-target="#carouselFantasia" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Anterior</span>
        </button>

        <button class="carousel-control-next" type="button" data-bs-target="#carouselFantasia" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">PrÃ³ximo</span>
        </button>
      </div>
    </section>

  </div>
</main>

<div class="modal fade" id="bookModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body d-flex gap-3">
        <img id="modalCover" src="" style="width:220px; border-radius:8px;">
        <div>
          <h6 id="modalAuthor" class="text-muted"></h6>
          <div id="modalRating"></div>
          <p id="modalSynopsis"></p>
          <p id="modalPages" class="text-muted"></p>
        </div>
      </div>

    </div>
  </div>
</div>

<footer class="sk-footer">
  <div class="container">
    Â© 2025 Skoob â€” Estante de Livros<br>
    <small>Laura & Maria â€¢ Todos os direitos reservados</small>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>


<!-- LÃ“GICA JAVASCRIPT DA PÃGINA -->
<script id="livros-json" type="application/json">
  {{ dados_livros | tojson }}
</script>

<script>
let topRated = [];
let suspense = [];
let romance = [];
let fantasia = [];

document.addEventListener("DOMContentLoaded", function() {
    console.log("ðŸš€ Iniciando script da livraria...");

    /* === teste de console === */
    try {
        const dadosBrutos = document.getElementById('livros-json').textContent;
        topRated = JSON.parse(dadosBrutos);
        
        console.log("âœ… Dados recebidos do Python:", topRated); 
    } catch (e) {
        console.error("âŒ Erro ao ler JSON:", e);
        return;
    }

    suspense = topRated.filter(b => b.category && b.category.trim() === "Suspense");
    romance = topRated.filter(b => b.category && b.category.trim() === "Romance");
    fantasia = topRated.filter(b => b.category && b.category.trim() === "Fantasia");

    console.log(`ðŸ“Š Filtros: Suspense(${suspense.length}), Romance(${romance.length}), Fantasia(${fantasia.length})`);

    /* === 4. RENDERIZA OS CARROSSEIS === */
    renderCarousel(suspense, "carouselSuspense");
    renderCarousel(romance, "carouselRomance");
    renderCarousel(fantasia, "carouselFantasia");
});

/* DivisÃ£o dos Slides  */
function chunkArray(arr, size) {
  const result = [];
  for (let i = 0; i < arr.length; i += size) result.push(arr.slice(i, i + size));
  return result;
}

/* === RENDERIZAÃ‡ÃƒO === */
function renderCarousel(categoryArray, carouselId) {
  const carouselInner = document.querySelector(`#${carouselId} .carousel-inner`);
  
  if (!carouselInner) {
      console.warn(`âš ï¸ Aviso: Elemento #${carouselId} nÃ£o encontrado no HTML.`);
      return; 
  }
  
  carouselInner.innerHTML = ""; 

  if (categoryArray.length === 0) {
      carouselInner.innerHTML = "<p class='text-center p-3 text-muted'>Nenhum livro encontrado nesta categoria.</p>";
      return;
  }

  const slides = chunkArray(categoryArray, 6);

  slides.forEach((slideBooks, index) => {
    const item = document.createElement("div");
    item.className = "carousel-item" + (index === 0 ? " active" : "");
    const grid = document.createElement("div");
    grid.className = "books-grid";

    slideBooks.forEach(b => {
      const node = document.createElement('article');
      node.className = 'book-card';
      
      // Define a imagem (com fallback seguro)
      const capaUrl = b.cover ? b.cover : '/static/images/capa-padrao.jpg';

      node.innerHTML = `
        <img 
            src="${capaUrl}" 
            alt="${b.title}" 
            class="cover"
            onerror="this.onerror=null; this.src='/static/images/capa-padrao.jpg';"
        >
        <div class="meta">
          <div class="book-title">${b.title}</div>
          <div class="book-author">por ${b.author || 'Desconhecido'}</div>
          <div class="rating-sm">
             ${'â˜…'.repeat(Math.round(b.rating || 0))} 
             <small class="text-muted">(${(b.rating || 0).toFixed(1)})</small>
          </div>
        </div>
        <div class="controls">
          <button class="add-to-shelf view-info">Ver Sobre</button>
          <button class="add-to-shelf add-book" onclick="adicionarAoBanco(${b.id}, this)">
            Adicionar Ã  estante
          </button>
        </div>
      `;

      node.querySelector('.view-info').addEventListener("click", (e) => {
        e.stopPropagation();
        openBookModal(b);
      });

      grid.appendChild(node);
    });

    item.appendChild(grid);
    carouselInner.appendChild(item);
  });
  
  // Controle das Setas
  const carouselEl = document.getElementById(carouselId);
  if(carouselEl && slides.length <= 1) {
      const prev = carouselEl.querySelector('.carousel-control-prev');
      const next = carouselEl.querySelector('.carousel-control-next');
      if(prev) prev.style.display = 'none';
      if(next) next.style.display = 'none';
  }
}

/* === MODAL === */
const modalElement = document.getElementById("bookModal");
const modal = modalElement ? new bootstrap.Modal(modalElement) : null;

function openBookModal(book){
  if (!modal) return;
  document.getElementById("modalTitle").textContent = book.title;
  document.getElementById("modalAuthor").textContent = "por " + (book.author || "Autor desconhecido");
  
  const img = document.getElementById("modalCover");
  img.src = book.cover ? book.cover : '/static/images/capa-padrao.jpg';
  img.onerror = function() { this.src = '/static/images/capa-padrao.jpg'; };

  const r = book.rating || 0;
  const stars = 'â˜…'.repeat(Math.round(r)) + 'â˜†'.repeat(5 - Math.round(r));
  document.getElementById("modalRating").innerHTML = `<span style="color:gold;font-size:1.2rem;">${stars}</span> <small>(${r.toFixed(1)})</small>`;
  
  document.getElementById("modalSynopsis").innerText = book.synopsis || "Sem sinopse.";
  
  const pgs = document.getElementById("modalPages");
  if(pgs) pgs.textContent = book.pages ? `${book.pages} pgs` : "";
  
  modal.show();
}

/* === AJAX === */
function adicionarAoBanco(id, btn) {
    const original = btn.innerText;
    btn.innerText = "Salvar...";
    btn.disabled = true;

    fetch(`/livros/add_ajax/${id}`)
        .then(r => {
            if(r.status === 401) throw new Error("LOGIN");
            return r.json();
        })
        .then(d => {
            if(d.ok) btn.innerText = "Salvo âœ”";
            else { alert(d.mensagem); btn.innerText = original; btn.disabled = false; }
        })
        .catch(e => {
            if(e.message === "LOGIN") {
                alert("FaÃ§a login!"); window.location.href="/";
            } else {
                console.error(e); alert("Erro ao salvar."); btn.innerText = original; btn.disabled = false;
            }
        });
}
</script>


</body>
</html>